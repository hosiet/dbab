<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.7" />
<title>Use new dbab to set Proxy automatically</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

pre {
  padding: 0;
  margin: 0;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

tt {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
}

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

.monospaced {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
}

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install();
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>Use new dbab to set Proxy automatically</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>In the past, we&#8217;ve covered</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="http://sfxpt.wordpress.com/2011/02/06/providing-dhcp-and-dns-services-with-dnsmasq/">Providing DHCP and DNS services with DNSMasq</a>
</p>
</li>
<li>
<p>
<a href="http://sfxpt.wordpress.com/2013/11/30/dnsmasq-installation-configuration-5/">DNSmasq Installation &amp; Configuration</a>
</p>
</li>
<li>
<p>
<a href="http://sfxpt.wordpress.com/2011/02/21/the-best-ad-blocking-method/">The Best Ad Blocking Method</a>
</p>
</li>
<li>
<p>
<a href="http://sfxpt.wordpress.com/2014/01/05/the-best-ad-blocking-method-in-a-package/">The Best Ad Blocking Method in a Package</a>
</p>
</li>
<li>
<p>
<a href="http://sfxpt.wordpress.com/2014/05/11/use-dbab-under-ubuntu-14-04-trusty/">Use dbab under Ubuntu 14.04 Trusty</a>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Now let&#8217;s continue on that trend to <a href="http://sfxpt.wordpress.com/2014/11/23/the-secret-behind-the-auto-proxy-setting/">auto proxy setting</a>. I.e., <a href="http://sfxpt.wordpress.com/2011/02/06/providing-dhcp-and-dns-services-with-dnsmasq/">DNSMasq gets DHCP and DNS together</a>, and <a href="http://sfxpt.wordpress.com/2014/01/05/the-best-ad-blocking-method-in-a-package/">the dbab</a> brings them both and <a href="http://sfxpt.wordpress.com/2011/02/21/the-best-ad-blocking-method/">ad blocking</a> together, and now let&#8217;s move a step further to bring <a href="http://en.wikipedia.org/wiki/Squid_(software)"><tt>squid</tt></a> and  <a href="http://sfxpt.wordpress.com/2014/11/23/the-secret-behind-the-auto-proxy-setting/">auto proxy setting</a> into the picture, and into the harmony.</p></div>
<!--more-->
<div class="paragraph"><p>Let&#8217;s make it easy for anyone visiting your home to enjoy you fast local <tt>squid</tt> caching server, and let&#8217;s start from all over as if this is the first time you are doing it. But please be warned, as there are so many pieces tied together, and thus so many things to configure, the following steps are long. So be warned and be prepared.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_static_ip">Static IP</h2>
<div class="sectionbody">
<div class="paragraph"><p>If you haven&#8217;t done <a href="http://sfxpt.wordpress.com/2014/05/11/use-dbab-under-ubuntu-14-04-trusty/">switching from dynamic IP to static IP</a> yet, check <a href="http://sfxpt.wordpress.com/2014/05/11/use-dbab-under-ubuntu-14-04-trusty/">it</a> out first for how to</p></div>
<div class="ulist"><ul>
<li>
<p>
configure the static IP, and
</p>
</li>
<li>
<p>
add a second static IP address
</p>
</li>
</ul></div>
<div class="paragraph"><p>and check out
<a href="http://sfxpt.wordpress.com/2011/02/21/the-best-ad-blocking-method/#Pixelserv_server_IP_address">here</a> if you want to know why to do that.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="strategy">Strategy</h2>
<div class="sectionbody">
<div class="paragraph"><p>The following instructions assume that there is a dedicated server in the SOHO environment for</p></div>
<div class="ulist"><ul>
<li>
<p>
DHCP, &amp; DNS using <a href="http://sfxpt.wordpress.com/2013/11/30/dnsmasq-installation-configuration-5/">DNSmasq</a>,
</p>
</li>
<li>
<p>
a caching server/proxy using squid.
</p>
</li>
<li>
<p>
and with <tt>dbab</tt> to provide WPAD &amp; pixelserv service and join them all together
</p>
</li>
</ul></div>
<div class="paragraph"><p>All of them are hosted on a single machine. This is a typical and reasonable configuration, because even with all above, the machine does not need to be a powerful or even a fast one. Mine is a Pentium 5, with 8G of RAM and 300G of disk space, and have a web server, a time server, a printing server, an email server and a SSH server installed as well, and it has more than enough power to handle everything.</p></div>
<div class="paragraph"><p>Once <tt>dbab</tt> is in the Debian repo, the installation will be so easy that what&#8217;s important is not the installation but the verification. But before then, use the following PPA for the installation repo instead:</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>add-apt-repository -y ppa:suntong001/ppa</tt></pre>
</div></div>
<div class="paragraph"><p>Then,</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<a href="http://sfxpt.wordpress.com/2014/05/11/use-dbab-under-ubuntu-14-04-trusty/">Switch from dynamic IP to static IP</a>.
</p>
</li>
<li>
<p>
<a href="http://sfxpt.wordpress.com/2013/11/30/dnsmasq-installation-configuration-5/">Install &amp; configure DNSmasq</a>.
</p>
</li>
<li>
<p>
Install <a href="http://en.wikipedia.org/wiki/Squid_(software)"><tt>squid</tt></a> caching server, nothing unusual about that.
</p>
</li>
<li>
<p>
Remove all existing ad blocking tools if you have any.
</p>
</li>
<li>
<p>
Stop your local web server temporarily if you have any.
</p>
</li>
<li>
<p>
Before installation <tt>dbab</tt>, go and visit some websites which have ads on their pages such as yahoo, abcnews or anything, then
</p>
</li>
<li>
<p>
Install &amp; configure the <tt>dbab</tt> package.
</p>
</li>
<li>
<p>
Restart your local web server if you have any.
</p>
</li>
<li>
<p>
Now, visit those pages again in different tabs to see if the ads are removed :-).
</p>
</li>
</ol></div>
<div class="paragraph"><p>That shall be it. Mission accomplished.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="install">Install dbab</h2>
<div class="sectionbody">
<div class="paragraph"><p>To install <tt>dbab</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">%</span> apt-get update

<span style="color: #990000">%</span> apt-get install dbab
The following extra packages will be installed<span style="color: #990000">:</span>
  curl dnsmasq
Suggested packages<span style="color: #990000">:</span>
  resolvconf
The following NEW packages will be installed<span style="color: #990000">:</span>
  curl dbab dnsmasq
<span style="color: #993399">0</span> upgraded<span style="color: #990000">,</span> <span style="color: #993399">3</span> newly installed<span style="color: #990000">,</span> <span style="color: #993399">0</span> to remove and <span style="color: #993399">0</span> not upgraded<span style="color: #990000">.</span>
Need to get <span style="color: #993399">145</span> kB of archives<span style="color: #990000">.</span>
After this operation<span style="color: #990000">,</span> <span style="color: #993399">482</span> kB of additional disk space will be used<span style="color: #990000">.</span>
Do you want to <span style="font-weight: bold"><span style="color: #0000FF">continue</span></span><span style="color: #990000">?</span> <span style="color: #990000">[</span>Y/n<span style="color: #990000">]</span> <span style="color: #990000">...</span></tt></pre></div></div>
</div>
</div>
<div class="sect1">
<h2 id="Configure">Configure <tt>dbab</tt> to work with a local web server</h2>
<div class="sectionbody">
<div class="paragraph"><p>First of all, <a href="http://sfxpt.wordpress.com/2014/05/11/use-dbab-under-ubuntu-14-04-trusty/">switch from dynamic IP to static IP and add a second static IP address</a> if you haven&#8217;t done so.</p></div>
<div class="paragraph"><p>Once we have our second IP address, the reset is simple:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
stop dbab-svr service
</p>
</li>
<li>
<p>
change the IP address that dbab uses to the second IP address
</p>
</li>
<li>
<p>
start dbab-svr service
</p>
</li>
<li>
<p>
start your local web server again if you have any
</p>
</li>
</ol></div>
<div class="paragraph"><p>In details, do the following as root, again assuming that the server&#8217;s own IP address is <tt>192.168.2.100</tt>, and its second IP is <tt>192.168.2.101</tt>. The second IP will be used for the dbab service (WPAD &amp; pixelserv).</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># (run the following as root)</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># stop dbab service</span></span>
/etc/init<span style="color: #990000">.</span>d/dbab stop

<span style="font-style: italic"><span style="color: #9A1900"># use the second IP for dbab-svr to listens on</span></span>
ip -f inet addr show eth0 <span style="color: #990000">|</span> awk <span style="color: #FF0000">'/inet /{print $2}'</span> <span style="color: #990000">|</span> sed <span style="color: #FF0000">'s|/.*$||; 1d'</span> <span style="color: #990000">|</span> sudo tee /etc/dbab<span style="color: #990000">.</span>addr
<span style="font-style: italic"><span style="color: #9A1900"># verify its content before moving on</span></span>
cat /etc/dbab<span style="color: #990000">.</span>addr
<span style="font-style: italic"><span style="color: #9A1900"># if it is not what you intent it to be, correct it with your text editor</span></span>
  <span style="font-style: italic"><span style="color: #9A1900"># or, set it manually (with a different IP address)</span></span>
  echo <span style="color: #993399">192.168</span><span style="color: #990000">.</span><span style="color: #993399">2.101</span> <span style="color: #990000">|</span> sudo tee /etc/dbab<span style="color: #990000">.</span>addr

<span style="font-style: italic"><span style="color: #9A1900"># update ad blocking list with the second IP address</span></span>
/usr/sbin/dbab-get-list
/usr/sbin/dbab-add-list

<span style="font-style: italic"><span style="color: #9A1900"># OPTIONAL! do the following only if you have squid caching server</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># and you want to enable automatic WPAD service</span></span>
hostname <span style="color: #990000">|</span> tee /etc/dbab<span style="color: #990000">.</span>proxy
  <span style="font-style: italic"><span style="color: #9A1900"># NB, if your squid caching server is on a different server, do this instead</span></span>
  echo my_squid_server_name <span style="color: #990000">|</span> tee /etc/dbab<span style="color: #990000">.</span>proxy
<span style="font-style: italic"><span style="color: #9A1900"># then,</span></span>
/usr/sbin/dhcp-add-wpad
<span style="font-style: italic"><span style="color: #9A1900"># Again verify everything here before moving on because script might not be</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># 100% time correct. Manually tweaking is inevitable sometimes.</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># restart DNS &amp; DHCP</span></span>
/etc/init<span style="color: #990000">.</span>d/dnsmasq restart

<span style="font-style: italic"><span style="color: #9A1900"># re-start dbab service</span></span>
/etc/init<span style="color: #990000">.</span>d/dbab start

<span style="font-style: italic"><span style="color: #9A1900"># re-start your local web server again if you have any</span></span></tt></pre></div></div>
<div class="paragraph"><p>That&#8217;s it. We&#8217;re done.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_verify">Verify</h2>
<div class="sectionbody">
<div class="paragraph"><p>To check ad blocking, revisit in new tabs those pages you just visited that full of ads, and compare the differences, or check out the following urls, which are automatically blocked by the <tt>dbab-get-list</tt> command:</p></div>
<div class="paragraph"><p><a href="http://actualdeals.com/">http://actualdeals.com/</a><br />
<a href="http://ad.about.com/">http://ad.about.com/</a><br />
<a href="http://ad.abcnews.com/">http://ad.abcnews.com/</a><br />
<a href="http://ad.abcnews.com/anything/else">http://ad.abcnews.com/anything/else</a><br /></p></div>
<div class="paragraph"><p>To check your automatic proxy setting, use:</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>$ curl http://wpad/wpad.dat
function FindProxyForURL(url, host) { return "PROXY mysohosvr:3128; DIRECT"; }</tt></pre>
</div></div>
<div class="paragraph"><p>The <tt>http://wpad/wpad.dat</tt> will always be the same regardless how your servers are called, but <tt>mysohosvr</tt> shall be the real name of your squid caching server.</p></div>
<div class="paragraph"><p>To check your automatic proxy results, first <a href="http://goo.gl/9uofLX#heading=h.7wr0f68pdads">set up your browser to use WPAD</a>, then on your SOHO server do the following before visiting any pages:</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>tail -f /var/log/squid3/access.log</tt></pre>
</div></div>
<div class="paragraph"><p>If the places you are visiting show up in the access log, then everything is working. Now fire up your iphone or ipad to visit some sites. As long as your iphone or ipad is using WIFI from your SOHO network, their visit will be cached as well. Or at least so I read. Check the access log to verify. As for Android, sorry, while iphone or ipad are playing by the rules to set proxy automatically from WPAD, Android isn&#8217;t. You have to set its proxy manually. Visit some pages with some very-slow-loading pictures, and they visit them again, the picture loading speed will be dramatically faster, especially if your wireless device is not super fast (like mine).</p></div>
<div class="paragraph"><p>If AOK, you may want to setup a cron job to update the block list on a weekly/monthly basis. E.g.:</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>ln -s /usr/sbin/dbab-get-list /etc/cron.weekly</tt></pre>
</div></div>
</div>
</div>
<div class="sect1">
<h2 id="advantages">Advantages</h2>
<div class="sectionbody">
<div class="paragraph"><p>Once again, here are the advantages of using dbab (Dnsmasq-Based Ad-Blocking).</p></div>
<div class="paragraph"><p>First of all, let&#8217;s recap why this is the best method for ad blocking. All other filter based solution (privoxy, Adblock Plus, etc) are CPU intensive because of a large quantity of ad urls need to be pattern matched, and using regular expressions matching is expensive. Adblock Plus, the easiest choice, is actually the worst choice because it is JavaScript based, and is the slowest. Furthermore, all these method will more or less alter the rendered web page, to remove the ads. This will be even slower, and might cause side effects as well.</p></div>
<div class="paragraph"><p>The <tt>dbab</tt> is however, using an entirely different approach for ad blocking. It&#8217;s advantages are:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>Work at the DNS level</strong>. Leave the web pages intact, without any pattern matching, string substitution, and/or html elements replacing.
</p>
</li>
<li>
<p>
<strong>Work for your mobile devices as well</strong>. Were you previously in the dilemma of choosing ads free or slow response for your mobile devices (iphone, ipad, etc)? Now you don&#8217;t. You don&#8217;t need to install any thing to your mobile devices for them to enjoy the ad-free browsing experience. Moreover, their browsing speed will increase dramatically on revisited pages/images.
</p>
</li>
<li>
<p>
<strong>Serve instantly</strong>. All ads will be replaced by a <tt>1x1</tt> pixel gif image locally served by the Pixelserv server.
</p>
</li>
<li>
<p>
<strong>Maintenance free</strong>. You don&#8217;t need to maintain the list of ad sites yourself. The block list can be downloaded from pgl.yoyo.org periodically. If you don&#8217;t like some of the entries there, you can define your local tweaking that filters them out.
</p>
</li>
<li>
<p>
<strong>Easily customized</strong>. It&#8217;s trivial to add your own entries to the ad blocking list if the existing ones are not enough for you.
</p>
</li>
</ul></div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2014-11-29 10:09:49 EST
</div>
</div>
</body>
</html>
